@using Main.Application.Dtos.Inventories.Index
@{
    var inventory = ViewBag.SelectedInventory as InventoryDto;
}

<div class="chat-container h-100 d-flex flex-column">
    <!-- Заголовок чата -->
    <div class="chat-header d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
        <div>
            <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>Inventory Discussion
            </h5>
            <small class="text-muted">Real-time chat for @inventory?.Name</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success" id="connectionStatus">
                <i class="fas fa-circle me-1"></i>
                <span class="status-text">Connected</span>
            </span>
            <span class="badge bg-primary" id="onlineCount">0 online</span>
        </div>
    </div>

    <!-- Контейнер сообщений -->
    <div class="chat-messages flex-grow-1 p-3" id="chatMessages"
         style="min-height: 400px; max-height: 60vh; overflow-y: auto;">

        <div class="text-center text-muted py-4" id="loadingMessages">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Loading messages...</span>
        </div>

        <!-- Сообщения будут загружаться здесь -->
    </div>

    <!-- Форма отправки -->
    <div class="chat-input border-top p-3 bg-light">
        <form id="messageForm" class="d-flex gap-2 align-items-start">
            <!-- Основное поле ввода -->
            <div class="flex-grow-1">
                <textarea id="messageInput"
                          class="form-control"
                          placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                          rows="2"
                          style="resize: none;"></textarea>

                <!-- Преview файла -->
                <div id="filePreview" class="mt-2" style="display: none;"></div>
            </div>

            <!-- Кнопки действий -->
            <div class="d-flex flex-column gap-2">
                <button type="submit" class="btn btn-primary" id="sendButton" title="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>

                <button type="button" class="btn btn-outline-secondary" id="attachButton" title="Attach file">
                    <i class="fas fa-paperclip"></i>
                </button>

                <button type="button" class="btn btn-outline-info" id="emojiButton" title="Add emoji">
                    <i class="fas fa-smile"></i>
                </button>
            </div>
        </form>

        <!-- Информация о форматировании -->
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Supports: <strong>**bold**</strong>, <em>*italic*</em>, <code>`code`</code>
            </small>
        </div>
    </div>
</div>

<!-- Скрытый input для загрузки файлов -->
<input type="file" id="fileInput" style="display: none;" accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt" />

<style>
    .chat-container {
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .chat-messages {
        background: white;
        border-radius: 0.375rem;
    }

    .chat-message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
        position: relative;
    }

        .chat-message.current-user {
            background: #e3f2fd;
            border-color: #bbdefb;
        }

        .chat-message .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .chat-message .user-name {
            color: #495057;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .chat-message .message-time {
            color: #6c757d;
            font-size: 0.75rem;
        }

        .chat-message .message-text {
            word-wrap: break-word;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .chat-message .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message:hover .message-actions {
            opacity: 1;
        }

    .system-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        margin: 1rem 0;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.25rem;
    }

    .file-attachment {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        margin-top: 0.5rem;
    }

    .file-link {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }

        .file-link:hover {
            text-decoration: underline;
        }

    .edited-badge {
        font-size: 0.7rem;
        color: #6c757d;
        margin-left: 0.5rem;
        font-style: italic;
    }

    /* Анимации */
    .chat-message {
        animation: messageAppear 0.3s ease-out;
    }

    @@keyframes messageAppear {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Адаптивность */
    @@media (max-width: 768px) {
        .chat-message .message-actions {
            position: static;
            opacity: 1;
            margin-top: 0.5rem;
        }

        .chat-input .d-flex {
            flex-direction: column;
        }

            .chat-input .d-flex > div:first-child {
                margin-bottom: 0.5rem;
            }
    }
</style>