@using Main.Application.Dtos
@using Main.Domain.enums.inventory
@model Main.Application.Dtos.InventoryFormDto

@{
    ViewData["Title"] = Model.PageTitle;
}

<h1>@Model.PageTitle</h1>
<hr />
<div class="row">
    <div class="col-md-12">
        <div id="autoSaveIndicator" class="alert alert-info d-none">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span id="autoSaveMessage">Auto-saving...</span>
            </div>
        </div>
        <form asp-action="@Model.FormAction" id="inventoryForm" data-is-edit="@Model.IsEditMode.ToString().ToLower()">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- ✅ Скрытые поля для автосохранения -->
            <input type="hidden" id="version" name="Version" value="@Model.Version" />
            <input type="hidden" id="lastSavedVersion" value="@Model.Version" />
            <input type="hidden" id="isDirty" value="false" />

            <!-- ✅ Скрытое поле для ID в режиме редактирования -->
            @if (Model.IsEditMode)
            {
                <input type="hidden" asp-for="Id" />
            }

            <!-- Табы для разных разделов -->
            <partial name="_InventoryTabs" />

            <div class="tab-content" id="inventoryTabsContent">
                <partial name="_BasicInfoTab" model="Model" />
                <partial name="_CustomIdTab" model="Model" />
                <partial name="_FieldsTab" model="Model" />
                <partial name="_TagsTab" model="Model" />
                <partial name="_AccessTab" model="Model" />
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">@Model.SubmitButtonText</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Back to List</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @* <script type="module" src="~/js/inventory-form.js"></script> *@
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // ===== AUTO-SAVE MANAGER =====
        let autoSaveManager = {
            isEditMode: document.getElementById('inventoryForm')?.dataset.isEdit === 'true',
            isDirty: false,
            saveTimer: null,
            isSaving: false,
            saveDelay: 8000, // 8 секунд

            init: function() {
                if (!this.isEditMode) {
                    console.log('Auto-save disabled: not in edit mode');
                    return;
                }

                console.log('Initializing auto-save for inventory editing');
                this.setupChangeTracking();
                this.setupPeriodicCheck();
                this.setupBeforeUnload();
            },

            setupChangeTracking: function() {
                const form = document.getElementById('inventoryForm');
                if (!form) return;

                // Отслеживание изменений в основных полях формы
                form.addEventListener('input', this.handleChange.bind(this));
                form.addEventListener('change', this.handleChange.bind(this));
            },

            handleChange: function(event) {
                if (event && event.target && event.target.type === 'hidden') return;

                console.log('Change detected, marking as dirty');
                this.markAsDirty();
                this.scheduleAutoSave();
            },

            markAsDirty: function() {
                if (!this.isDirty) {
                    this.isDirty = true;
                    const isDirtyElement = document.getElementById('isDirty');
                    if (isDirtyElement) {
                        isDirtyElement.value = 'true';
                    }
                    this.updateSaveIndicator('Unsaved changes', false, 'warning');
                }
            },

            scheduleAutoSave: function() {
                if (this.saveTimer) {
                    clearTimeout(this.saveTimer);
                }

                this.saveTimer = setTimeout(() => {
                    this.performAutoSave();
                }, this.saveDelay);
            },

            async performAutoSave() {
                if (!this.isDirty || this.isSaving || !this.isEditMode) {
                    console.log('Auto-save skipped:', {
                        isDirty: this.isDirty,
                        isSaving: this.isSaving,
                        isEditMode: this.isEditMode
                    });
                    return;
                }

                this.isSaving = true;
                this.updateSaveIndicator('Auto-saving...', true);

                try {
                    const formData = this.prepareFormData();
                    console.log('Performing auto-save with data:', formData);

                    const response = await fetch('/Inventories/AutoSave', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': this.getAntiForgeryToken()
                        },
                        body: JSON.stringify(formData)
                    });

                    console.log('Auto-save response status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Auto-save result:', result);

                        if (result.success) {
                            this.handleSaveSuccess(result);
                        } else {
                            this.handleSaveError(result);
                        }
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Auto-save failed:', error);
                    this.handleSaveError({ message: 'Auto-save failed. Please save manually.' });
                } finally {
                    this.isSaving = false;
                }
            },

            prepareFormData: function() {
                // Обновляем скрытые поля перед отправкой
                if (typeof generatePreview === 'function') {
                    generatePreview();
                }
                if (typeof updateTagsDisplay === 'function') {
                    updateTagsDisplay();
                }

                const data = {
                    Id: document.querySelector('input[name="Id"]')?.value,
                    Name: document.querySelector('input[name="Name"]')?.value,
                    Description: document.querySelector('textarea[name="Description"]')?.value,
                    CategoryId: document.querySelector('input[name="CategoryId"]')?.value,
                    ImageUrl: document.querySelector('input[name="ImageUrl"]')?.value,
                    IsPublic: document.querySelector('input[name="IsPublic"]')?.checked || false,
                    Version: document.getElementById('Version')?.value,
                    CustomIdFormat: document.getElementById('hiddenCustomIdFormat')?.value,
                    Tags: this.getTagsArray(),
                    Fields: this.collectFieldsData()
                };

                return data;
            },

            getTagsArray: function() {
                const hiddenTags = document.getElementById('hiddenTags');
                if (hiddenTags && hiddenTags.value) {
                    try {
                        return JSON.parse(hiddenTags.value);
                    } catch (e) {
                        console.error('Error parsing tags:', e);
                        return [];
                    }
                }
                return [];
            },

            collectFieldsData: function() {
                const fields = [];
                const fieldElements = document.querySelectorAll('.field-item');

                fieldElements.forEach((fieldElement, index) => {
                    const nameInput = fieldElement.querySelector('input[name$=".Name"]');
                    const typeSelect = fieldElement.querySelector('select[name$=".FieldType"]');
                    const orderInput = fieldElement.querySelector('input[name$=".OrderIndex"]');
                    const descTextarea = fieldElement.querySelector('textarea[name$=".Description"]');
                    const visibleCheckbox = fieldElement.querySelector('input[name$=".IsVisibleInTable"]');
                    const requiredCheckbox = fieldElement.querySelector('input[name$=".IsRequired"]');
                    const idInput = fieldElement.querySelector('input[name$=".Id"]');

                    const field = {
                        Id: idInput ? parseInt(idInput.value) : 0,
                        Name: nameInput ? nameInput.value : '',
                        FieldType: typeSelect ? parseInt(typeSelect.value) : 0,
                        OrderIndex: orderInput ? parseInt(orderInput.value) : index,
                        Description: descTextarea ? descTextarea.value : '',
                        IsVisibleInTable: visibleCheckbox ? visibleCheckbox.checked : false,
                        IsRequired: requiredCheckbox ? requiredCheckbox.checked : false
                    };

                    fields.push(field);
                });

                return fields;
            },

            getAntiForgeryToken: function() {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenElement ? tokenElement.value : '';
            },

            handleSaveSuccess: function(result) {
                this.isDirty = false;
                const isDirtyElement = document.getElementById('isDirty');
                if (isDirtyElement) {
                    isDirtyElement.value = 'false';
                }

                const lastSavedVersion = document.getElementById('lastSavedVersion');
                const Version = document.getElementById('Version');
                if (lastSavedVersion && Version) {
                    lastSavedVersion.value = result.Version;
                    Version.value = result.Version;
                }

                this.updateSaveIndicator('All changes saved', false, 'success');

                setTimeout(() => {
                    this.hideSaveIndicator();
                }, 3000);
            },

            handleSaveError: function(result) {
                console.error('Auto-save error:', result);
                this.updateSaveIndicator(result.message || 'Auto-save failed', false, 'danger');

                if (result.isConcurrencyError) {
                    this.handleConcurrencyError(result);
                }
            },

            handleConcurrencyError: function(result) {
                const userChoice = confirm(
                    'This inventory was modified by another user. ' +
                    'Do you want to reload the page to see the latest changes? ' +
                    'Your unsaved changes will be lost.'
                );

                if (userChoice) {
                    window.location.reload();
                }
            },

            updateSaveIndicator: function(message, showSpinner = false, type = 'info') {
                const indicator = document.getElementById('autoSaveIndicator');
                const messageElement = document.getElementById('autoSaveMessage');

                if (!indicator) {
                    console.warn('Auto-save indicator element not found');
                    return;
                }

                // Обновляем классы в зависимости от типа
                indicator.className = `alert alert-${type} ${showSpinner ? '' : 'd-none'}`;
                if (messageElement) {
                    messageElement.textContent = message;
                }

                if (message) {
                    indicator.classList.remove('d-none');
                }
            },

            hideSaveIndicator: function() {
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.classList.add('d-none');
                }
            },

            setupPeriodicCheck: function() {
                setInterval(() => {
                    if (this.isDirty && !this.isSaving) {
                        console.log('Periodic check: triggering auto-save');
                        this.performAutoSave();
                    }
                }, 30000);
            },

            setupBeforeUnload: function() {
                window.addEventListener('beforeunload', (event) => {
                    if (this.isDirty) {
                        event.preventDefault();
                        event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                        return event.returnValue;
                    }
                });
            }
        };

        let componentCount = 0;
        let components = [];

        // Initialize Sortable for drag & drop
                // ===== ACCESS MANAGEMENT =====
        let accessManager = {
            users: [],
            currentAccessList: @Html.Raw(Json.Serialize(Model.AccessList ?? new List<InventoryAccessDto>())),

            init: function() {
                this.setupUserSearch();
                this.setupSorting();
                this.loadUserDetails();
                this.setupRemoveAccess();
            },

            setupUserSearch: function() {
                const searchInput = document.getElementById('userSearchInput');
                const searchResults = document.getElementById('userSearchResults');
                const searchBtn = document.getElementById('searchUserBtn');

                if (!searchInput) return;

                // Поиск при вводе
                searchInput.addEventListener('input', this.debounce((e) => {
                    const query = e.target.value.trim();
                    if (query.length >= 2) {
                        this.searchUsers(query);
                    } else {
                        this.hideSearchResults();
                    }
                }, 300));

                // Поиск по кнопке
                searchBtn.addEventListener('click', () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        this.searchUsers(query);
                    }
                });

                // Закрытие результатов при клике вне
                document.addEventListener('click', (e) => {
                    if (!searchResults.contains(e.target) && e.target !== searchInput) {
                        this.hideSearchResults();
                    }
                });
            },

               async searchUsers(query) {
            try {
                const response = await fetch(`/Search/search-users?query=${encodeURIComponent(query)}&limit=10`);
                if (response.ok) {
                    const users = await response.json();
                    this.displaySearchResults(users);
                } else {
                    console.error('Search failed with status:', response.status);
                    this.hideSearchResults();
                }
            } catch (error) {
                console.error('Search failed:', error);
                this.hideSearchResults();
            }
        },

        async loadUserDetails() {
            const userIds = this.currentAccessList.map(access => access.userId);

            if (userIds.length === 0) return;

            try {
                const response = await fetch('/Search/users-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': this.getAntiForgeryToken()
                    },
                    body: JSON.stringify({ userIds: userIds })
                });

                if (response.ok) {
                    const usersDetails = await response.json();
                    this.updateUserDetailsInTable(usersDetails);
                }
            } catch (error) {
                console.error('Failed to load user details:', error);
            }
        },

                   displaySearchResults(users) {
            const resultsContainer = document.getElementById('userSearchResults');
            if (!resultsContainer) return;

            if (users.length === 0) {
                resultsContainer.innerHTML = '<div class="dropdown-item text-muted">No users found</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            let html = '';
            users.forEach(user => {
                // Проверяем, не добавлен ли уже пользователь
                const isAlreadyAdded = this.currentAccessList.some(access => access.userId === user.id);

                html += `
                    <div class="dropdown-item d-flex justify-content-between align-items-center ${isAlreadyAdded ? 'text-muted' : ''}"
                         data-user-id="${user.id}"
                         data-user-email="${user.email}"
                         data-user-name="${user.firstName} ${user.lastName}">
                        <div>
                            <div class="fw-semibold">${user.firstName} ${user.lastName}</div>
                            <small class="text-muted">${user.email}</small>
                        </div>
                        ${isAlreadyAdded ?
                            '<span class="badge bg-secondary">Already added</span>' :
                            '<button type="button" class="btn btn-sm btn-outline-primary add-user-btn">Add</button>'
                        }
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';

            // Обработка добавления пользователей - ИСПРАВЛЕННАЯ ВЕРСИЯ
            resultsContainer.querySelectorAll('.add-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); // Предотвращаем действие по умолчанию
                    e.stopPropagation(); // Останавливаем всплытие события
                    const item = btn.closest('.dropdown-item');
                    this.addUserToAccessList(
                        item.dataset.userId,
                        item.dataset.userName,
                        item.dataset.userEmail
                    );
                    this.hideSearchResults();
                    document.getElementById('userSearchInput').value = '';
                });
            });
        },

            hideSearchResults() {
                const resultsContainer = document.getElementById('userSearchResults');
                if (resultsContainer) {
                    resultsContainer.style.display = 'none';
                }
            },

            addUserToAccessList(userId, userName, userEmail) {
                // Проверяем, не добавлен ли уже пользователь
                if (this.currentAccessList.some(access => access.userId === userId)) {
                    this.showToast('User already has access', 'warning');
                    return;
                }

                const accessLevel = parseInt(document.getElementById('accessLevelSelect').value);
                const grantedAt = new Date().toISOString();

                // Добавляем в текущий список
                this.currentAccessList.push({
                    userId: userId,
                    accessLevel: accessLevel,
                    grantedAt: grantedAt
                });

                // Обновляем UI
                this.updateAccessListUI();

                // Обновляем скрытые поля формы
                this.updateHiddenAccessFields();

                this.showToast('User added successfully', 'success');

                // Триггер автосохранения
                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            },

            removeUserFromAccessList(userId) {
                this.currentAccessList = this.currentAccessList.filter(access => access.userId !== userId);
                this.updateAccessListUI();
                this.updateHiddenAccessFields();

                // Триггер автосохранения
                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            },

            updateAccessListUI() {
                const tbody = document.getElementById('accessListBody');
                if (!tbody) return;

                // Сортируем список согласно выбранным настройкам
                const sortedList = this.getSortedAccessList();

                if (sortedList.length === 0) {
                    tbody.innerHTML = `
                        <tr id="noAccessMessage">
                            <td colspan="4" class="text-center text-muted py-4">
                                No users have access to this inventory yet.
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                sortedList.forEach(access => {
                    html += `
                        <tr data-user-id="${access.userId}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                        <span class="text-white">${access.userName?.charAt(0)?.toUpperCase() || 'U'}</span>
                                    </div>
                                    <div>
                                        <div class="fw-semibold user-name">${access.userName || 'Loading...'}</div>
                                        <small class="text-muted user-email">${access.userEmail || 'Loading...'}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge ${this.getAccessLevelBadgeClass(access.accessLevel)}">
                                    ${this.getAccessLevelText(access.accessLevel)}
                                </span>
                            </td>
                            <td class="granted-date">${new Date(access.grantedAt).toLocaleString()}</td>
                            <td>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger remove-access"
                                        data-user-id="${access.userId}"
                                        title="Remove Access">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                this.setupRemoveAccess();
                this.loadUserDetails(); // Загружаем детали пользователей
            },

            updateHiddenAccessFields() {
                const container = document.getElementById('accessListData');
                if (!container) return;

                let html = '';
                this.currentAccessList.forEach((access, index) => {
                    html += `
                        <input type="hidden" name="AccessList[${index}].UserId" value="${access.userId}" />
                        <input type="hidden" name="AccessList[${index}].AccessLevel" value="${access.accessLevel}" />
                        <input type="hidden" name="AccessList[${index}].GrantedAt" value="${access.grantedAt}" />
                    `;
                });

                container.innerHTML = html;
            },

            async loadUserDetails() {
                const userIds = this.currentAccessList.map(access => access.userId);

                if (userIds.length === 0) return;

                try {
                    const response = await fetch('/Search/users-details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': autoSaveManager.getAntiForgeryToken()
                        },
                        body: JSON.stringify({ userIds: userIds })
                    });

                    if (response.ok) {
                        const usersDetails = await response.json();
                        this.updateUserDetailsInTable(usersDetails);
                    }
                } catch (error) {
                    console.error('Failed to load user details:', error);
                }
            },

            updateUserDetailsInTable(usersDetails) {
                usersDetails.forEach(user => {
                    const row = document.querySelector(`tr[data-user-id="${user.id}"]`);
                    if (row) {
                        const nameElement = row.querySelector('.user-name');
                        const emailElement = row.querySelector('.user-email');

                        if (nameElement) nameElement.textContent = `${user.firstName} ${user.lastName}`;
                        if (emailElement) emailElement.textContent = user.email;
                    }
                });
            },

            setupRemoveAccess() {
                document.querySelectorAll('.remove-access').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.closest('button').dataset.userId;
                        if (confirm('Are you sure you want to remove access for this user?')) {
                            this.removeUserFromAccessList(userId);
                        }
                    });
                });
            },

            setupSorting() {
                const sortBy = document.getElementById('sortAccessList');
                const sortOrder = document.getElementById('sortAccessOrder');

                if (sortBy && sortOrder) {
                    const updateSort = () => {
                        this.updateAccessListUI();
                    };

                    sortBy.addEventListener('change', updateSort);
                    sortOrder.addEventListener('change', updateSort);
                }
            },

            getSortedAccessList() {
                const sortBy = document.getElementById('sortAccessList')?.value || 'name';
                const sortOrder = document.getElementById('sortAccessOrder')?.value || 'asc';

                return [...this.currentAccessList].sort((a, b) => {
                    let aValue, bValue;

                    switch (sortBy) {
                        case 'name':
                            aValue = a.userName?.toLowerCase() || '';
                            bValue = b.userName?.toLowerCase() || '';
                            break;
                        case 'email':
                            aValue = a.userEmail?.toLowerCase() || '';
                            bValue = b.userEmail?.toLowerCase() || '';
                            break;
                        case 'accessLevel':
                            aValue = a.accessLevel;
                            bValue = b.accessLevel;
                            break;
                        case 'grantedAt':
                            aValue = new Date(a.grantedAt);
                            bValue = new Date(b.grantedAt);
                            break;
                        default:
                            aValue = a.userName?.toLowerCase() || '';
                            bValue = b.userName?.toLowerCase() || '';
                    }

                    if (sortOrder === 'desc') {
                        [aValue, bValue] = [bValue, aValue];
                    }

                    if (aValue < bValue) return -1;
                    if (aValue > bValue) return 1;
                    return 0;
                });
            },

            getAccessLevelBadgeClass(accessLevel) {
                switch (accessLevel) {
                    case 1: return 'bg-secondary';
                    case 2: return 'bg-primary';
                    case 3: return 'bg-success';
                    default: return 'bg-secondary';
                }
            },

            getAccessLevelText(accessLevel) {
                switch (accessLevel) {
                    case 1: return 'Read Only';
                    case 2: return 'Read & Write';
                    case 3: return 'Admin';
                    default: return 'Unknown';
                }
            },

            showToast(message, type = 'info') {
                // Простая реализация toast уведомления
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                toast.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Инициализация менеджера доступа при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            accessManager.init();
            const formatComponents = document.getElementById('formatComponents');

            if (formatComponents) {
                Sortable.create(formatComponents, {
                    animation: 150,
                    ghostClass: 'bg-warning',
                    onEnd: function(evt) {
                        updateComponentsOrder();
                        generatePreview();
                        // Trigger auto-save
                        if (autoSaveManager.isEditMode) {
                            autoSaveManager.handleChange();
                        }
                    }
                });

                initializeDragToRemove();
            }

            // Initialize auto-save
            autoSaveManager.init();

            // Initialize sample components
            addComponent('fixed-text');
            addComponent('sequence');
            generatePreview();

            // Initialize fields from model
            initializeFieldsFromModel();

            // Initialize tags from model
            @if (Model.Tags != null && Model.Tags.Any())
            {
                        foreach (var tag in Model.Tags)
                        {
                                    <text>addTag('@tag');</text>
                        }
            }
        });

        function initializeDragToRemove() {
            const formatBuilder = document.getElementById('formatBuilder');
            if (!formatBuilder) return;

            formatBuilder.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-danger');
            });

            formatBuilder.addEventListener('dragleave', function(e) {
                this.classList.remove('border-danger');
            });

            formatBuilder.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-danger');

                const componentId = e.dataTransfer.getData('text/plain');
                removeComponent(componentId);
            });
        }

        function addComponent(type) {
            componentCount++;
            const componentId = `component-${componentCount}`;

            let componentHtml = '';
            let defaultValue = '';

            switch (type) {
                case 'fixed-text':
                    componentHtml = `
                        <div class="component-item badge bg-primary p-2" draggable="true" data-type="fixed-text" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>Fixed Text</span>
                            <input type="text" class="form-control form-control-sm d-inline-block w-auto ms-1"
                                   placeholder="Enter text" value="ITEM"
                                   onchange="updateComponent('${componentId}', this.value)" />
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = 'ITEM';
                    break;

                case 'random-20bit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-20bit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>20-bit Random</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R20}';
                    break;

                case 'random-32bit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-32bit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>32-bit Random</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R32}';
                    break;

                case 'random-6digit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-6digit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>6-digit Random</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R6D}';
                    break;

                case 'random-9digit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-9digit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>9-digit Random</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R9D}';
                    break;

                case 'guid':
                    componentHtml = `
                        <div class="component-item badge bg-info p-2" draggable="true" data-type="guid" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>GUID</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{GUID}';
                    break;

                case 'datetime':
                    componentHtml = `
                        <div class="component-item badge bg-warning text-dark p-2" draggable="true" data-type="datetime" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>Date/Time</span>
                            <select class="form-select form-select-sm d-inline-block w-auto ms-1" onchange="updateComponent('${componentId}', this.value)">
                                <option value="{YYYYMMDD}">YYYYMMDD</option>
                                <option value="{YYMMDD}">YYMMDD</option>
                                <option value="{YYYY-MM-DD}">YYYY-MM-DD</option>
                                <option value="{DDMMYYYY}">DDMMYYYY</option>
                                <option value="{UNIX}">Unix Timestamp</option>
                            </select>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{YYYYMMDD}';
                    break;

                case 'sequence':
                    componentHtml = `
                        <div class="component-item badge bg-danger p-2" draggable="true" data-type="sequence" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>Sequence</span>
                            <input type="number" class="form-control form-control-sm d-inline-block w-auto ms-1"
                                   value="6" min="1" max="10"
                                   onchange="updateComponent('${componentId}', '{SEQ:' + this.value + '}')" />
                            <span class="ms-1">digits</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{SEQ:6}';
                    break;
            }

            // Add component to UI
            const noComponentsMessage = document.getElementById('noComponentsMessage');
            const formatComponents = document.getElementById('formatComponents');

            if (noComponentsMessage) {
                noComponentsMessage.style.display = 'none';
            }
            if (formatComponents) {
                formatComponents.insertAdjacentHTML('beforeend', componentHtml);
            }

            // Add to components array
            components.push({
                id: componentId,
                type: type,
                value: defaultValue
            });

            // Initialize drag events
            const componentElement = document.getElementById(componentId);
            if (componentElement) {
                componentElement.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', componentId);
                });
            }

            generatePreview();

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function removeComponent(componentId) {
            // Remove from UI
            const componentElement = document.getElementById(componentId);
            if (componentElement) {
                componentElement.remove();
            }

            // Remove from components array
            components = components.filter(c => c.id !== componentId);

            // Show message if no components left
            if (components.length === 0) {
                const noComponentsMessage = document.getElementById('noComponentsMessage');
                if (noComponentsMessage) {
                    noComponentsMessage.style.display = 'block';
                }
            }

            generatePreview();

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function updateComponent(componentId, value) {
            const component = components.find(c => c.id === componentId);
            if (component) {
                component.value = value;
                generatePreview();

                // Trigger auto-save if in edit mode
                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            }
        }

        function updateComponentsOrder() {
            const componentElements = document.querySelectorAll('.component-item');
            const newComponents = [];

            componentElements.forEach(element => {
                const componentId = element.id;
                const existingComponent = components.find(c => c.id === componentId);
                if (existingComponent) {
                    newComponents.push(existingComponent);
                }
            });

            components = newComponents;
        }

        function generatePreview() {
            let preview = '';

            components.forEach(component => {
                switch (component.type) {
                    case 'fixed-text':
                        preview += component.value || 'TEXT';
                        break;
                    case 'random-20bit':
                        preview += Math.floor(Math.random() * 1048576).toString().padStart(6, '0');
                        break;
                    case 'random-32bit':
                        preview += Math.floor(Math.random() * 4294967296).toString().padStart(10, '0');
                        break;
                    case 'random-6digit':
                        preview += Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                        break;
                    case 'random-9digit':
                        preview += Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
                        break;
                    case 'guid':
                        preview += 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            const r = Math.random() * 16 | 0;
                            const v = c == 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                        break;
                    case 'datetime':
                        const now = new Date();
                        switch (component.value) {
                            case '{YYYYMMDD}':
                                preview += now.toISOString().slice(0,10).replace(/-/g, '');
                                break;
                            case '{YYMMDD}':
                                preview += now.toISOString().slice(2,10).replace(/-/g, '').slice(0,6);
                                break;
                            case '{YYYY-MM-DD}':
                                preview += now.toISOString().slice(0,10);
                                break;
                            case '{DDMMYYYY}':
                                preview += now.toISOString().slice(8,10) + now.toISOString().slice(5,7) + now.toISOString().slice(0,4);
                                break;
                            case '{UNIX}':
                                preview += Math.floor(now.getTime() / 1000);
                                break;
                            default:
                                preview += now.toISOString().slice(0,10).replace(/-/g, '');
                        }
                        break;
                    case 'sequence':
                        const digits = parseInt(component.value.replace('{SEQ:', '').replace('}', '')) || 6;
                        preview += '1'.padStart(digits, '0');
                        break;
                }
            });

            const previewElement = document.getElementById('customIdPreview');
            if (previewElement) {
                previewElement.value = preview;
            }

            // Update the hidden field for form submission
            const formatString = components.map(c => c.value).join('');
            const hiddenFormatElement = document.getElementById('hiddenCustomIdFormat');
            if (hiddenFormatElement) {
                hiddenFormatElement.value = formatString;
            }
        }

        // ===== FIELDS AND TAGS MANAGEMENT =====
        let tags = [];
        let fieldCount = 0;

        // Функция для добавления поля с данными
        function addField(fieldData = null) {
            const currentIndex = fieldCount;
            fieldCount++;

            // Значения по умолчанию или из fieldData
            const fieldName = fieldData?.name || '';
            const fieldId = fieldData?.id || 0;
            const fieldType = fieldData?.fieldType || '';
            const orderIndex = fieldData?.orderIndex || currentIndex;
            const description = fieldData?.description || '';
            const isVisibleInTable = fieldData?.isVisibleInTable ?? true;
            const isRequired = fieldData?.isRequired ?? false;

            const fieldHtml = `
                <div class="field-item card mb-3" id="field-${currentIndex}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">Field #${fieldCount}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField(${currentIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">Field Name *</label>
                                    <input name="Fields[${currentIndex}].Name"
                                           class="form-control field-name"
                                           value="${fieldName}"
                                           required />
                                    <input type="hidden"
                                           name="Fields[${currentIndex}].Id"
                                           value="${fieldId}" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">Field Type *</label>
                                    <select name="Fields[${currentIndex}].FieldType" class="form-select field-type" required>
                                        <option value="">Select Type</option>
                                        <option value="0" ${fieldType === '0' ? 'selected' : ''}>Text</option>
                                        <option value="1" ${fieldType === '1' ? 'selected' : ''}>MultilineText</option>
                                        <option value="2" ${fieldType === '2' ? 'selected' : ''}>Number</option>
                                        <option value="3" ${fieldType === '3' ? 'selected' : ''}>Boolean</option>
                                        <option value="4" ${fieldType === '4' ? 'selected' : ''}>File</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">Order Index</label>
                                    <input name="Fields[${currentIndex}].OrderIndex"
                                           type="number"
                                           class="form-control"
                                           value="${orderIndex}" />
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="Fields[${currentIndex}].Description"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Optional field description">${description}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input name="Fields[${currentIndex}].IsVisibleInTable"
                                           class="form-check-input"
                                           type="checkbox"
                                           value="true"
                                           ${isVisibleInTable ? 'checked' : ''} />
                                    <label class="form-check-label">Visible in table</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input name="Fields[${currentIndex}].IsRequired"
                                           class="form-check-input"
                                           type="checkbox"
                                           value="true"
                                           ${isRequired ? 'checked' : ''} />
                                    <label class="form-check-label">Required field</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const noFieldsMessage = document.getElementById('noFieldsMessage');
            const fieldsContainer = document.getElementById('fieldsContainer');

            if (noFieldsMessage) {
                noFieldsMessage.style.display = 'none';
            }
            if (fieldsContainer) {
                fieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            }

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        // Функция для инициализации полей из модели
        function initializeFieldsFromModel() {
            @if (Model.Fields != null && Model.Fields.Any())
            {
                        foreach (var field in Model.Fields)
                        {
                                    <text>
                                    addField({
                                        id: @field.Id,
                                        name: '@Html.Raw((field.Name ?? ""))',
                                        fieldType: '@((int)field.FieldType)',
                                        orderIndex: @field.OrderIndex,
                                        description: '@Html.Raw((field.Description ?? ""))',
                                        isVisibleInTable: @field.IsVisibleInTable.ToString().ToLower(),
                                        isRequired: @field.IsRequired.ToString().ToLower()
                                    });
                                    </text>
                        }
            }
            else
            {
                        <text>
                        // Добавляем первое поле автоматически только при создании
                        if (!@Model.IsEditMode.ToString().ToLower()) {
                            addField();
                        }
                        </text>
            }
        }

        function removeField(index) {
            const fieldElement = document.getElementById(`field-${index}`);
            if (fieldElement) {
                fieldElement.remove();
            }

            reindexFields();

            if (document.querySelectorAll('.field-item').length === 0) {
                const noFieldsMessage = document.getElementById('noFieldsMessage');
                if (noFieldsMessage) {
                    noFieldsMessage.style.display = 'block';
                }
                fieldCount = 0;
            }

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function reindexFields() {
            const fieldItems = document.querySelectorAll('.field-item');
            fieldCount = 0;

            fieldItems.forEach((item, index) => {
                item.id = `field-${index}`;
                const title = item.querySelector('.card-title');
                if (title) {
                    title.textContent = `Field #${index + 1}`;
                }
                updateFieldIndexes(item, index);
                fieldCount++;
            });
        }

        function updateFieldIndexes(fieldElement, newIndex) {
            const inputs = fieldElement.querySelectorAll('[name^="Fields["]');

            inputs.forEach(input => {
                const name = input.name;
                const newName = name.replace(/Fields\[\d+\]/, `Fields[${newIndex}]`);
                input.name = newName;

                if (newName.includes('OrderIndex')) {
                    input.value = newIndex;
                }
            });

            const removeBtn = fieldElement.querySelector('button[onclick]');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeField(${newIndex})`);
            }
        }

        // Управление тегами
        const tagInput = document.getElementById('tagInput');
        if (tagInput) {
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTag(this.value.trim().replace(',', ''));
                    this.value = '';
                }
            });
        }

        function addTag(tagText) {
            if (tagText && !tags.includes(tagText)) {
                tags.push(tagText);
                updateTagsDisplay();

                // Trigger auto-save if in edit mode
                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            }
        }

        function removeTag(tagText) {
            tags = tags.filter(tag => tag !== tagText);
            updateTagsDisplay();

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function updateTagsDisplay() {
            const container = document.getElementById('tagsContainer');
            const hiddenInput = document.getElementById('hiddenTags');

            if (container) {
                container.innerHTML = '';
            }
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(tags);
            }

            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge bg-primary me-2 mb-2';
                tagElement.innerHTML = `
                    ${tag}
                    <button type="button" class="btn-close btn-close-white ms-1" onclick="removeTag('${tag}')"></button>
                `;
                if (container) {
                    container.appendChild(tagElement);
                }
            });
        }

    </script>

    <style>
        .component-item {
            cursor: move;
            user-select: none;
        }

        .min-height-50 {
            min-height: 50px;
        }

        #formatBuilder {
            transition: border-color 0.3s ease;
        }

        .component-item input,
        .component-item select {
            font-size: 0.8rem;
        }

        .nav-tabs .nav-link {
            font-weight: 500;
        }

        .field-item {
            border-left: 4px solid #007bff;
        }
    </style>
}
