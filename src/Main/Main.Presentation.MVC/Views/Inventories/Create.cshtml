@using Main.Application.Dtos.Inventories.Index
@using Main.Presentation.MVC.ViewModel
@using Microsoft.Extensions.Localization
@model InventoryFormViewModel
@inject IStringLocalizer<SharedResource> Localizer

@{
    ViewData["Title"] = Model.PageTitle;
}

<h1>@Model.PageTitle</h1>
<hr />

<div class="row">
    <div class="col-md-12">
        <div id="autoSaveIndicator" class="alert alert-info d-none">
        </div>
        
        <form asp-action="@Model.FormAction" id="inventoryForm" 
              data-is-edit="@Model.IsEditMode.ToString().ToLower()" 
              enctype="multipart/form-data">
              
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" id="version" name="Version" value="@Model.Version" />

            @if (Model.IsEditMode)
            {
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="OwnerId" />
            }

            <!-- Табы -->
            <partial name="~/Views/Inventories/Partials/_InventoryTabs.cshtml" />
            
            <div class="tab-content" id="inventoryTabsContent">
                <partial name="~/Views/Inventories/Partials/_BasicInfoTab.cshtml" model="Model" />
                <partial name="~/Views/Inventories/Partials/_CustomIdTab.cshtml" model="Model" />
                <partial name="~/Views/Inventories/Partials/_FieldsTab.cshtml" model="Model" />
                <partial name="~/Views/Inventories/Partials/_TagsTab.cshtml" model="Model" />
                <partial name="~/Views/Inventories/Partials/_AccessTab.cshtml" model="Model" />
            </div>

            <!-- Кнопки действий -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">@Model.SubmitButtonText</button>
                <a asp-action="Index" class="btn btn-outline-secondary">@Localizer["Back"]</a>
            </div>
        </form>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @* <script type="module" src="~/js/inventory-form.js"></script> *@
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // ===== AUTO-SAVE MANAGER =====
        let autoSaveManager = {
            isEditMode: document.getElementById('inventoryForm')?.dataset.isEdit === 'true',
            isDirty: false,
            saveTimer: null,
            isSaving: false,
            saveDelay: 8000,

            init: function() {
                if (!this.isEditMode) {
                    return;
                }
                this.setupChangeTracking();
                this.setupPeriodicCheck();
                this.setupBeforeUnload();
            },

            setupChangeTracking: function() {
                const form = document.getElementById('inventoryForm');
                if (!form) return;

                form.addEventListener('input', this.handleChange.bind(this));
                form.addEventListener('change', this.handleChange.bind(this));
            },

            handleChange: function(event) {
                if (event && event.target && event.target.type === 'hidden') return;

                this.markAsDirty();
                this.scheduleAutoSave();
            },

            markAsDirty: function() {
                if (!this.isDirty) {
                    this.isDirty = true;
                    const isDirtyElement = document.getElementById('isDirty');
                    if (isDirtyElement) {
                        isDirtyElement.value = 'true';
                    }
                    this.updateSaveIndicator('Unsaved changes', false, 'warning');
                }
            },

            scheduleAutoSave: function() {
                if (this.saveTimer) {
                    clearTimeout(this.saveTimer);
                }

                this.saveTimer = setTimeout(() => {
                    this.performAutoSave();
                }, this.saveDelay);
            },

            async performAutoSave() {
                if (!this.isDirty || this.isSaving || !this.isEditMode) {
                    console.log('Auto-save skipped:', {
                        isDirty: this.isDirty,
                        isSaving: this.isSaving,
                        isEditMode: this.isEditMode
                    });
                    return;
                }

                this.isSaving = true;
                this.updateSaveIndicator(`@Localizer["Auto-saving"]`, true);
                try {
                    const formData = this.prepareFormData();

                    const response = await fetch('/Inventories/AutoSave', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': this.getAntiForgeryToken()
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.success) {
                            this.handleSaveSuccess(result);
                        } else {
                            this.handleSaveError(result);
                        }
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    this.handleSaveError({ message: '@Localizer["Auto-save"] @Localizer["failed"] @Localizer["Please save manually"].' });
                } finally {
                    this.isSaving = false;
                }
            },

            prepareFormData: function() {
                if (typeof generatePreview === 'function') {
                    generatePreview();
                }
                if (typeof updateTagsDisplay === 'function') {
                    updateTagsDisplay();
                }

                const data = {
                    Id: document.querySelector('input[name="Id"]')?.value,
                    Name: document.querySelector('input[name="Name"]')?.value,
                    Description: document.querySelector('textarea[name="Description"]')?.value,
                    CategoryId: document.querySelector('input[name="CategoryId"]')?.value,
                    ImageUrl: document.querySelector('input[name="ImageUrl"]')?.value,
                    IsPublic: document.querySelector('input[name="IsPublic"]')?.checked || false,
                    Version: document.getElementById('Version')?.value,
                    CustomIdFormat: document.getElementById('hiddenCustomIdFormat')?.value,
                    Tags: this.getTagsArray(),
                    Fields: this.collectFieldsData()
                };

                return data;
            },

            getTagsArray: function() {
                const hiddenTags = document.getElementById('hiddenTags');
                if (hiddenTags && hiddenTags.value) {
                    try {
                        return JSON.parse(hiddenTags.value);
                    } catch (e) {
                        return [];
                    }
                }
                return [];
            },

            collectFieldsData: function() {
                const fields = [];
                const fieldElements = document.querySelectorAll('.field-item');

                fieldElements.forEach((fieldElement, index) => {
                    const nameInput = fieldElement.querySelector('input[name$=".Name"]');
                    const typeSelect = fieldElement.querySelector('select[name$=".FieldType"]');
                    const orderInput = fieldElement.querySelector('input[name$=".OrderIndex"]');
                    const descTextarea = fieldElement.querySelector('textarea[name$=".Description"]');
                    const visibleCheckbox = fieldElement.querySelector('input[name$=".IsVisibleInTable"]');
                    const requiredCheckbox = fieldElement.querySelector('input[name$=".IsRequired"]');
                    const idInput = fieldElement.querySelector('input[name$=".Id"]');

                    const field = {
                        Id: idInput ? parseInt(idInput.value) : 0,
                        Name: nameInput ? nameInput.value : '',
                        FieldType: typeSelect ? parseInt(typeSelect.value) : 0,
                        OrderIndex: orderInput ? parseInt(orderInput.value) : index,
                        Description: descTextarea ? descTextarea.value : '',
                        IsVisibleInTable: visibleCheckbox ? visibleCheckbox.checked : false,
                        IsRequired: requiredCheckbox ? requiredCheckbox.checked : false
                    };

                    fields.push(field);
                });

                return fields;
            },

            getAntiForgeryToken: function() {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenElement ? tokenElement.value : '';
            },

            handleSaveSuccess: function(result) {
                this.isDirty = false;
                const isDirtyElement = document.getElementById('isDirty');
                if (isDirtyElement) {
                    isDirtyElement.value = 'false';
                }

                const lastSavedVersion = document.getElementById('lastSavedVersion');
                const Version = document.getElementById('Version');
                if (lastSavedVersion && Version) {
                    lastSavedVersion.value = result.Version;
                    Version.value = result.Version;
                }

                this.updateSaveIndicator('@Localizer["All changes saved"]', false, 'success');

                setTimeout(() => {
                    this.hideSaveIndicator();
                }, 3000);
            },

            handleSaveError: function(result) {
                console.error('Auto-save error:', result);
                this.updateSaveIndicator(result.message || '@Localizer["Auto-save"] @Localizer["failed"]', false, 'danger');

                if (result.isConcurrencyError) {
                    this.handleConcurrencyError(result);
                }
            },

            handleConcurrencyError: function(result) {
                const userChoice = confirm(
                        '@Localizer["This inventory was modified by another user."]' +
        '@Localizer["Do you want to reload the page to see the latest changes?"]' +
        '@Localizer["Your unsaved changes will be lost."]'
                );

                if (userChoice) {
                    window.location.reload();
                }
            },

            updateSaveIndicator: function(message, showSpinner = false, type = 'info') {
                const indicator = document.getElementById('autoSaveIndicator');
                const messageElement = document.getElementById('autoSaveMessage');

                if (!indicator) {
                    console.warn('Auto-save indicator element not found');
                    return;
                }

                indicator.className = `alert alert-${type} ${showSpinner ? '' : 'd-none'}`;
                if (messageElement) {
                    messageElement.textContent = message;
                }

                if (message) {
                    indicator.classList.remove('d-none');
                }
            },

            hideSaveIndicator: function() {
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.classList.add('d-none');
                }
            },

            setupPeriodicCheck: function() {
                setInterval(() => {
                    if (this.isDirty && !this.isSaving) {
                        this.performAutoSave();
                    }
                }, 30000);
            },

            setupBeforeUnload: function() {
                window.addEventListener('beforeunload', (event) => {
                    if (this.isDirty) {
                        event.preventDefault();
                        event.returnValue = "You have unsaved changes. Are you sure you want to leave?";
                        return event.returnValue;
                    }
                });
            }
        };

        let componentCount = 0;
        let components = [];

               // ===== ACCESS MANAGEMENT =====
        let accessManager = {
            users: [],
            currentAccessList: @Html.Raw(Json.Serialize(Model.AccessList ?? new List<InventoryAccessDto>())),
            dataTable: null,

            init: function() {
                this.setupUserSearch();
                this.initializeDataTable();
                this.setupRemoveAccess();
            },

            initializeDataTable: function() {
                this.dataTable = $('#accessListTable').DataTable({
                    pageLength: 10,
                    responsive: true,
                    order: [[2, 'desc']], // Сортировка по дате создания по умолчанию
                    columnDefs: [
                        {
                            orderable: false,
                            targets: [3] // Отключаем сортировку для действий
                        },
                        {
                            width: "100px",
                            targets: [3] // Фиксируем ширину колонки действий
                        }
                    ],
                    language: {
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        search: "Search:",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        },
                        emptyTable: "@Localizer["No users have access to this inventory yet"]."
                    },
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
                    data: [], // Изначально пустые данные
                    columns: [
                        {
                            data: 'userInfo',
                            render: function(data, type, row) {
                                return `
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                            <span class="text-white">${(row.userEmail || 'U').charAt(0).toUpperCase()}</span>
                                        </div>
                                        <div>
                                            <div class="fw-semibold user-name">${row.userName || '@Localizer["Loading"]...'}</div>
                                            <small class="text-muted user-email">${row.userEmail || '@Localizer["Loading"]...'}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                        {
                            data: 'accessLevel',
                            render: function(data, type, row) {
                                const badgeClass = accessManager.getAccessLevelBadgeClass(row.accessLevel);
                                const accessText = accessManager.getAccessLevelText(row.accessLevel);
                                return `<span class="badge ${badgeClass}">${accessText}</span>`;
                            }
                        },
                        {
                            data: 'grantedAt',
                            render: function(data, type, row) {
                                return new Date(row.grantedAt).toLocaleString();
                            }
                        },
                        {
                            data: 'userId',
                            render: function(data, type, row) {
                                return `
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger remove-access"
                                            data-user-id="${row.userId}"
                                            title="@Localizer["Remove Access"]">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                            }
                        }
                    ]
                });

                // Загружаем начальные данные
                this.loadInitialData();
            },

            loadInitialData: function() {
                // Преобразуем currentAccessList в формат для DataTables
                const tableData = this.currentAccessList.map(access => ({
                    userId: access.userId,
                    userName: access.userName || '',
                    userEmail: access.userEmail || '',
                    accessLevel: access.accessLevel,
                    grantedAt: access.grantedAt,
                    userInfo: '' // Будет заполнено через render
                }));

                // Добавляем данные в таблицу
                this.dataTable.clear().rows.add(tableData).draw();

                // Загружаем детали пользователей
                this.loadUserDetails();
            },

            setupUserSearch: function() {
                const searchInput = document.getElementById('userSearchInput');
                const searchResults = document.getElementById('userSearchResults');
                const searchBtn = document.getElementById('searchUserBtn');

                if (!searchInput) return;

                searchInput.addEventListener('input', this.debounce((e) => {
                    const query = e.target.value.trim();
                    if (query.length >= 2) {
                        this.searchUsers(query);
                    } else {
                        this.hideSearchResults();
                    }
                }, 300));

                searchBtn.addEventListener('click', () => {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        this.searchUsers(query);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!searchResults.contains(e.target) && e.target !== searchInput) {
                        this.hideSearchResults();
                    }
                });
            },

            async searchUsers(query) {
                try {
                    const response = await fetch(`/Search/search-users?query=${encodeURIComponent(query)}&limit=10`);
                    if (response.ok) {
                        const users = await response.json();
                        this.displaySearchResults(users);
                    } else {
                        console.error('Search failed with status:', response.status);
                        this.hideSearchResults();
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                    this.hideSearchResults();
                }
            },

            displaySearchResults(users) {
                const resultsContainer = document.getElementById('userSearchResults');
                if (!resultsContainer) return;

                if (users.length === 0) {
                    resultsContainer.innerHTML = '<div class="dropdown-item text-muted">@Localizer["No users found"]</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }

                let html = '';
                users.forEach(user => {
                    const isAlreadyAdded = this.currentAccessList.some(access => access.userId === user.id);

                    html += `
                        <div class="dropdown-item d-flex justify-content-between align-items-center ${isAlreadyAdded ? 'text-muted' : ''}"
                             data-user-id="${user.id}"
                             data-user-email="${user.email}"
                             data-user-name="${user.firstName} ${user.lastName}">
                            <div>
                                <div class="fw-semibold">${user.firstName} ${user.lastName}</div>
                                <small class="text-muted">${user.email}</small>
                            </div>
                            ${isAlreadyAdded ?
                                '<span class="badge bg-secondary">@Localizer["Already added"]</span>' :
                                `<button type="button" class="btn btn-sm btn-outline-primary add-user-btn">@Localizer["Add"]</button>`
                            }
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';

                resultsContainer.querySelectorAll('.add-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const item = btn.closest('.dropdown-item');
                        this.addUserToAccessList(
                            item.dataset.userId,
                            item.dataset.userName,
                            item.dataset.userEmail
                        );
                        this.hideSearchResults();
                        document.getElementById('userSearchInput').value = '';
                    });
                });
            },

            hideSearchResults() {
                const resultsContainer = document.getElementById('userSearchResults');
                if (resultsContainer) {
                    resultsContainer.style.display = 'none';
                }
            },

            addUserToAccessList(userId, userName, userEmail) {
                if (this.currentAccessList.some(access => access.userId === userId)) {
                    this.showToast('@Localizer["User already has access"]', 'warning');
                    return;
                }

                const accessLevel = parseInt(document.getElementById('accessLevelSelect').value);
                const grantedAt = new Date().toISOString();

                const newAccess = {
                    userId: userId,
                    userName: userName,
                    userEmail: userEmail,
                    accessLevel: accessLevel,
                    grantedAt: grantedAt
                };

                this.currentAccessList.push(newAccess);

                // Добавляем новую строку в DataTable
                this.dataTable.row.add({
                    userId: userId,
                    userName: userName,
                    userEmail: userEmail,
                    accessLevel: accessLevel,
                    grantedAt: grantedAt,
                    userInfo: ''
                }).draw();

                this.updateHiddenAccessFields();

                this.showToast('@Localizer["User added successfully"]', 'success');

                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            },

            removeUserFromAccessList(userId) {
                // Удаляем из текущего списка
                this.currentAccessList = this.currentAccessList.filter(access => access.userId !== userId);

                // Удаляем строку из DataTable
                this.dataTable.rows().every(function() {
                    const rowData = this.data();
                    if (rowData.userId === userId) {
                        this.remove();
                        return false;
                    }
                    return true;
                });

                this.dataTable.draw();
                this.updateHiddenAccessFields();

                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            },

            setupRemoveAccess() {
                // Используем делегирование событий для динамически добавляемых кнопок
                $('#accessListTable').on('click', '.remove-access', (e) => {
                    const userId = $(e.target).closest('button').data('user-id');
                    if (confirm('@Localizer["Are you sure you want to remove access for this user?"]')) {
                        this.removeUserFromAccessList(userId);
                    }
                });
            },

            async loadUserDetails() {
                const userIds = this.currentAccessList.map(access => access.userId);

                if (userIds.length === 0) return;

                try {
                    const response = await fetch('/Search/users-details', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': autoSaveManager.getAntiForgeryToken()
                        },
                        body: JSON.stringify({ userIds: userIds })
                    });

                    if (response.ok) {
                        const usersDetails = await response.json();
                        this.updateUserDetailsInTable(usersDetails);
                    }
                } catch (error) {
                    console.error('Failed to load user details:', error);
                }
            },

            updateUserDetailsInTable(usersDetails) {
                this.dataTable.rows().every(function() {
                    const rowData = this.data();
                    const userDetail = usersDetails.find(user => user.id === rowData.userId);

                    if (userDetail) {
                        rowData.userName = `${userDetail.firstName} ${userDetail.lastName}`;
                        rowData.userEmail = userDetail.email;
                        this.data(rowData);
                    }

                    return true;
                });

                this.dataTable.draw();
            },

            updateHiddenAccessFields() {
                const container = document.getElementById('accessListData');
                if (!container) return;

                let html = '';
                this.currentAccessList.forEach((access, index) => {
                    html += `
                        <input type="hidden" name="AccessList[${index}].UserId" value="${access.userId}" />
                        <input type="hidden" name="AccessList[${index}].AccessLevel" value="${access.accessLevel}" />
                        <input type="hidden" name="AccessList[${index}].GrantedAt" value="${access.grantedAt}" />
                    `;
                });

                container.innerHTML = html;
            },

            getAccessLevelBadgeClass(accessLevel) {
                switch (accessLevel) {
                    case 1: return 'bg-secondary';
                    case 2: return 'bg-primary';
                    case 3: return 'bg-success';
                    default: return 'bg-secondary';
                }
            },

            getAccessLevelText(accessLevel) {
                switch (accessLevel) {
                    case 1: return '@Localizer["Read Only"]';
                    case 2: return '@Localizer["Read & Write"]';
                    case 3: return '@Localizer["Admin"]';
                    default: return '@Localizer["Unknown"]';
                }
            },

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                toast.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            accessManager.init();
            const formatComponents = document.getElementById('formatComponents');

            if (formatComponents) {
                Sortable.create(formatComponents, {
                    animation: 150,
                    ghostClass: 'bg-warning',
                    onEnd: function(evt) {
                        updateComponentsOrder();
                        generatePreview();

                        if (autoSaveManager.isEditMode) {
                            autoSaveManager.handleChange();
                        }
                    }
                });

                initializeDragToRemove();
            }

            autoSaveManager.init();

            addComponent('fixed-text');
            addComponent('sequence');
            generatePreview();

            initializeFieldsFromModel();

            @if (Model.Tags != null && Model.Tags.Any())
            {
                            foreach (var tag in Model.Tags)
                            {
                                            <text>addTag('@tag');</text>
                            }
            }
        });

        function initializeDragToRemove() {
            const formatBuilder = document.getElementById('formatBuilder');
            if (!formatBuilder) return;

            formatBuilder.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-danger');
            });

            formatBuilder.addEventListener('dragleave', function(e) {
                this.classList.remove('border-danger');
            });

            formatBuilder.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-danger');

                const componentId = e.dataTransfer.getData('text/plain');
                removeComponent(componentId);
            });
        }

        function addComponent(type) {
            componentCount++;
            const componentId = `component-${componentCount}`;

            let componentHtml = '';
            let defaultValue = '';

            switch (type) {
                case 'fixed-text':
                    componentHtml = `
                        <div class="component-item badge bg-primary p-2" draggable="true" data-type="fixed-text" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>@Localizer["Text"]</span>
                            <input type="text" class="form-control form-control-sm d-inline-block w-auto ms-1"
                                   placeholder="Enter text" value='@Localizer["ITEM"]'
                                   onchange="updateComponent('${componentId}', this.value)" />
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = 'ITEM';
                    break;

                case 'random-20bit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-20bit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>20-bit @Localizer["Random"]</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R20}';
                    break;

                case 'random-32bit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-32bit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>32-bit @Localizer["Random"]</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R32}';
                    break;

                case 'random-6digit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-6digit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>6-digit @Localizer["Random"]</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R6D}';
                    break;

                case 'random-9digit':
                    componentHtml = `
                        <div class="component-item badge bg-success p-2" draggable="true" data-type="random-9digit" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>9-digit @Localizer["Random"]</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{R9D}';
                    break;

                case 'guid':
                    componentHtml = `
                        <div class="component-item badge bg-info p-2" draggable="true" data-type="guid" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>@Localizer["GUID"]</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{GUID}';
                    break;

                case 'datetime':
                    componentHtml = `
                        <div class="component-item badge bg-warning text-dark p-2" draggable="true" data-type="datetime" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>@Localizer["Date/Time"]</span>
                            <select class="form-select form-select-sm d-inline-block w-auto ms-1" onchange="updateComponent('${componentId}', this.value)">
                                <option value="{YYYYMMDD}">YYYYMMDD</option>
                                <option value="{YYMMDD}">YYMMDD</option>
                                <option value="{YYYY-MM-DD}">YYYY-MM-DD</option>
                                <option value="{DDMMYYYY}">DDMMYYYY</option>
                            </select>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{YYYYMMDD}';
                    break;

                case 'sequence':
                    componentHtml = `
                        <div class="component-item badge bg-danger p-2" draggable="true" data-type="sequence" id="${componentId}">
                            <i class="fas fa-grip-vertical me-1"></i>
                            <span>@Localizer["sequence"]</span>
                            <input type="number" class="form-control form-control-sm d-inline-block w-auto ms-1"
                                   value="6" min="1" max="10"
                                   onchange="updateComponent('${componentId}', '{SEQ:' + this.value + '}')" />
                            <span class="ms-1">digits</span>
                            <button type="button" class="btn-close btn-close-white ms-1" onclick="removeComponent('${componentId}')"></button>
                        </div>
                    `;
                    defaultValue = '{SEQ:6}';
                    break;
            }

            const noComponentsMessage = document.getElementById('noComponentsMessage');
            const formatComponents = document.getElementById('formatComponents');

            if (noComponentsMessage) {
                noComponentsMessage.style.display = 'none';
            }
            if (formatComponents) {
                formatComponents.insertAdjacentHTML('beforeend', componentHtml);
            }

            components.push({
                id: componentId,
                type: type,
                value: defaultValue
            });

            const componentElement = document.getElementById(componentId);
            if (componentElement) {
                componentElement.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', componentId);
                });
            }

            generatePreview();

            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function removeComponent(componentId) {
            const componentElement = document.getElementById(componentId);
            if (componentElement) {
                componentElement.remove();
            }

            components = components.filter(c => c.id !== componentId);

            if (components.length === 0) {
                const noComponentsMessage = document.getElementById('noComponentsMessage');
                if (noComponentsMessage) {
                    noComponentsMessage.style.display = 'block';
                }
            }

            generatePreview();

            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function updateComponent(componentId, value) {
            const component = components.find(c => c.id === componentId);
            if (component) {
                component.value = value;
                generatePreview();

                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            }
        }

        function updateComponentsOrder() {
            const componentElements = document.querySelectorAll('.component-item');
            const newComponents = [];

            componentElements.forEach(element => {
                const componentId = element.id;
                const existingComponent = components.find(c => c.id === componentId);
                if (existingComponent) {
                    newComponents.push(existingComponent);
                }
            });

            components = newComponents;
        }

        function generatePreview() {
            let preview = '';

            components.forEach(component => {
                switch (component.type) {
                    case 'fixed-text':
                        preview += component.value || 'TEXT';
                        break;
                    case 'random-20bit':
                        preview += Math.floor(Math.random() * 1048576).toString().padStart(6, '0');
                        break;
                    case 'random-32bit':
                        preview += Math.floor(Math.random() * 4294967296).toString().padStart(10, '0');
                        break;
                    case 'random-6digit':
                        preview += Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                        break;
                    case 'random-9digit':
                        preview += Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
                        break;
                    case 'guid':
                        preview += 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            const r = Math.random() * 16 | 0;
                            const v = c == 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                        break;
                    case 'datetime':
                        const now = new Date();
                        switch (component.value) {
                            case '{YYYYMMDD}':
                                preview += now.toISOString().slice(0,10).replace(/-/g, '');
                                break;
                            case '{YYMMDD}':
                                preview += now.toISOString().slice(2,10).replace(/-/g, '').slice(0,6);
                                break;
                            case '{YYYY-MM-DD}':
                                preview += now.toISOString().slice(0,10);
                                break;
                            case '{DDMMYYYY}':
                                preview += now.toISOString().slice(8,10) + now.toISOString().slice(5,7) + now.toISOString().slice(0,4);
                                break;
                            case '{UNIX}':
                                preview += Math.floor(now.getTime() / 1000);
                                break;
                            default:
                                preview += now.toISOString().slice(0,10).replace(/-/g, '');
                        }
                        break;
                    case 'sequence':
                        const digits = parseInt(component.value.replace('{SEQ:', '').replace('}', '')) || 6;
                        preview += '1'.padStart(digits, '0');
                        break;
                }
            });

            const previewElement = document.getElementById('customIdPreview');
            if (previewElement) {
                previewElement.value = preview;
            }

            const formatString = components.map(c => c.value).join('');
            const hiddenFormatElement = document.getElementById('hiddenCustomIdFormat');
            if (hiddenFormatElement) {
                hiddenFormatElement.value = formatString;
            }
        }

        // ===== FIELDS AND TAGS MANAGEMENT =====
        let tags = [];
        let fieldCount = 0;

        // Функция для добавления поля с данными
        function addField(fieldData = null) {
            const currentIndex = fieldCount;
            fieldCount++;

            // Значения по умолчанию или из fieldData
            const fieldName = fieldData?.name || '';
            const fieldId = fieldData?.id || 0;
            const fieldType = fieldData?.fieldType || '';
            const orderIndex = fieldData?.orderIndex || currentIndex;
            const description = fieldData?.description || '';
            const isVisibleInTable = fieldData?.isVisibleInTable ?? true;
            const isRequired = fieldData?.isRequired ?? false;

            const fieldHtml = `
                <div class="field-item card mb-3" id="field-${currentIndex}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">Field #${fieldCount}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField(${currentIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">@Localizer["Field Name"] *</label>
                                    <input name="Fields[${currentIndex}].Name"
                                           class="form-control field-name"
                                           value="${fieldName}"
                                           required />
                                    <input type="hidden"
                                           name="Fields[${currentIndex}].Id"
                                           value="${fieldId}" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">@Localizer["Field Type"] *</label>
                                    <select name="Fields[${currentIndex}].FieldType" class="form-select field-type" required>
                                        <option value="">Select Type</option>
                                        <option value="0" ${fieldType === '0' ? 'selected' : ''}>@Localizer["Text"]</option>
                                        <option value="1" ${fieldType === '1' ? 'selected' : ''}>@Localizer["MultilineText"]</option>
                                        <option value="2" ${fieldType === '2' ? 'selected' : ''}>@Localizer["Number"]</option>
                                        <option value="3" ${fieldType === '3' ? 'selected' : ''}>@Localizer["Boolean"]</option>
                                        <option value="4" ${fieldType === '4' ? 'selected' : ''}>@Localizer["File"]</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label class="form-label">@Localizer["Order Index"]</label>
                                    <input name="Fields[${currentIndex}].OrderIndex"
                                           type="number"
                                           class="form-control"
                                           value="${orderIndex}" />
                                </div>
                            </div>
                        </div>

                         <div class="form-group mb-3">
                            <label asp-for="Description" class="form-label">
                            @Localizer["Description"]
                            <small class="text-muted">(@Localizer["Supports"] Markdown)</small>
                            </label>
                            <textarea name="Fields[${currentIndex}].Description" class="form-control" rows="2"
                                  placeholder="@Localizer["Supports"] **@Localizer["bold"]**, *@Localizer["italic"]*, [links](http://example.com), etc."></textarea>

                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Markdown:</strong>
                                **@Localizer["bold"]**, *@Localizer["italic"]*
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input name="Fields[${currentIndex}].IsVisibleInTable"
                                           class="form-check-input"
                                           type="checkbox"
                                           value="true"
                                           ${isVisibleInTable ? 'checked' : ''} />
                                    <label class="form-check-label">@Localizer["Visible in table"]</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input name="Fields[${currentIndex}].IsRequired"
                                           class="form-check-input"
                                           type="checkbox"
                                           value="true"
                                           ${isRequired ? 'checked' : ''} />
                                    <label class="form-check-label">@Localizer["Required field"]</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const noFieldsMessage = document.getElementById('noFieldsMessage');
            const fieldsContainer = document.getElementById('fieldsContainer');

            if (noFieldsMessage) {
                noFieldsMessage.style.display = 'none';
            }
            if (fieldsContainer) {
                fieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            }

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function initializeFieldsFromModel() {
            @if (Model.Fields != null && Model.Fields.Any())
            {
                            foreach (var field in Model.Fields)
                            {
                                            <text>
                                            addField({
                                                id: @field.Id,
                                                name: '@Html.Raw((field.Name ?? ""))',
                                                fieldType: '@((int)field.FieldType)',
                                                orderIndex: @field.OrderIndex,
                                                description: '@Html.Raw((field.Description ?? ""))',
                                                isVisibleInTable: @field.IsVisibleInTable.ToString().ToLower(),
                                                isRequired: @field.IsRequired.ToString().ToLower()
                                            });
                                            </text>
                            }
            }
            else
            {
                            <text>
                            // Добавляем первое поле автоматически только при создании
                            if (!@Model.IsEditMode.ToString().ToLower()) {
                                addField();
                            }
                            </text>
            }
        }

        function removeField(index) {
            const fieldElement = document.getElementById(`field-${index}`);
            if (fieldElement) {
                fieldElement.remove();
            }

            reindexFields();

            if (document.querySelectorAll('.field-item').length === 0) {
                const noFieldsMessage = document.getElementById('noFieldsMessage');
                if (noFieldsMessage) {
                    noFieldsMessage.style.display = 'block';
                }
                fieldCount = 0;
            }

            // Trigger auto-save if in edit mode
            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function reindexFields() {
            const fieldItems = document.querySelectorAll('.field-item');
            fieldCount = 0;

            fieldItems.forEach((item, index) => {
                item.id = `field-${index}`;
                const title = item.querySelector('.card-title');
                if (title) {
                    title.textContent = `Field #${index + 1}`;
                }
                updateFieldIndexes(item, index);
                fieldCount++;
            });
        }

        function updateFieldIndexes(fieldElement, newIndex) {
            const inputs = fieldElement.querySelectorAll('[name^="Fields["]');

            inputs.forEach(input => {
                const name = input.name;
                const newName = name.replace(/Fields\[\d+\]/, `Fields[${newIndex}]`);
                input.name = newName;

                if (newName.includes('OrderIndex')) {
                    input.value = newIndex;
                }
            });

            const removeBtn = fieldElement.querySelector('button[onclick]');
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeField(${newIndex})`);
            }
        }

        // Управление тегами
        const tagInput = document.getElementById('tagInput');
        if (tagInput) {
            tagInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTag(this.value.trim().replace(',', ''));
                    this.value = '';
                }
            });
        }

        function addTag(tagText) {
            if (tagText && !tags.includes(tagText)) {
                tags.push(tagText);
                updateTagsDisplay();

                if (autoSaveManager.isEditMode) {
                    autoSaveManager.handleChange();
                }
            }
        }

        function removeTag(tagText) {
            tags = tags.filter(tag => tag !== tagText);
            updateTagsDisplay();

            if (autoSaveManager.isEditMode) {
                autoSaveManager.handleChange();
            }
        }

        function updateTagsDisplay() {
            const container = document.getElementById('tagsContainer');
            const hiddenInput = document.getElementById('hiddenTags');

            if (container) {
                container.innerHTML = '';
            }
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(tags);
            }

            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge bg-primary me-2 mb-2';
                tagElement.innerHTML = `
                    ${tag}
                    <button type="button" class="btn-close btn-close-white ms-1" onclick="removeTag('${tag}')"></button>
                `;
                if (container) {
                    container.appendChild(tagElement);
                }
            });
        }

    </script>

    <style>
        .component-item {
            cursor: move;
            user-select: none;
        }

        .min-height-50 {
            min-height: 50px;
        }

        #formatBuilder {
            transition: border-color 0.3s ease;
        }

        .component-item input,
        .component-item select {
            font-size: 0.8rem;
        }

        .nav-tabs .nav-link {
            font-weight: 500;
        }

        .field-item {
            border-left: 4px solid #007bff;
        }
    </style>
}
